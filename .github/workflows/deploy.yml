name: Deploy to Cloud Run Function

on:
  push:
    branches: [ main ]

permissions:
  contents: read
  id-token: write

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GAR_LOCATION: asia-east1
  SERVICE: app-engine-service
  REGION: asia-east1

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    # 使用現有的 WIF 設定
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
        service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
    
    # 設定 Docker 認證
    - name: Configure Docker to use gcloud as credential helper
      run: |
        gcloud auth configure-docker $GAR_LOCATION-docker.pkg.dev
    
    # 建立 Artifact Registry repository (如果不存在)
    - name: Create Artifact Registry repository
      run: |
        gcloud artifacts repositories create $SERVICE \
          --repository-format=docker \
          --location=$GAR_LOCATION \
          --description="Docker repository for $SERVICE" || true
    
    # 建立並推送 Docker image
    - name: Build and Push Container
      run: |
        docker build -t "$GAR_LOCATION-docker.pkg.dev/$PROJECT_ID/$SERVICE/$SERVICE:$GITHUB_SHA" .
        docker push "$GAR_LOCATION-docker.pkg.dev/$PROJECT_ID/$SERVICE/$SERVICE:$GITHUB_SHA"
    
    # 部署到 Cloud Run
    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy $SERVICE \
          --image=$GAR_LOCATION-docker.pkg.dev/$PROJECT_ID/$SERVICE/$SERVICE:$GITHUB_SHA \
          --region=$REGION \
          --allow-unauthenticated \
          --port=8080 \
          --memory=512Mi \
          --cpu=1 \
          --quiet
    
    # 顯示部署結果
    - name: Show service URL
      run: |
        gcloud run services describe $SERVICE --region=$REGION --format='value(status.url)'
